# This is the ci workflow to run after the docker push

name: CI

# Run action after the docker push
on:
  workflow_run:
    workflows:
      - Docker
    types:
      - completed

  # Allows to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  table1-vulnerable:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # Retrieves the name of the docker image we want to use
      - id: docker-name
        uses: ./.github/workflows/scripts/docker-image-name/

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      # Runs this job's script
      - name: Table 1 - Vulnerable Intel SGX-SDK
        run: |
          SCRIPT="source ./sdk_helper.sh vulnerable && cd 01_table1_basic-poc && ./eval_simulator.sh"
          docker run ${{ steps.docker-name.outputs.image-id }}:${{ steps.docker-name.outputs.image-version }} /bin/bash -c "$SCRIPT"
  
  table1-patched:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # Retrieves the name of the docker image we want to use
      - id: docker-name
        uses: ./.github/workflows/scripts/docker-image-name/

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      # Runs this job's script
      - name: Table 1 - Patched Intel SGX-SDK
        run: |
          SCRIPT="source ./sdk_helper.sh patched && cd 01_table1_basic-poc && ./eval_simulator.sh"
          docker run ${{ steps.docker-name.outputs.image-id }}:${{ steps.docker-name.outputs.image-version }} /bin/bash -c "$SCRIPT"
